<!-- Modern Profile Page -->

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Hồ Sơ Cá Nhân</h2>
        <p class="text-secondary mb-0">Quản lý thông tin tài khoản của bạn</p>
    </div>
</div>

<div class="row g-4">
    <!-- Profile Info Card -->
    <div class="col-lg-4">
        <div class="card card-bordered">
            <div class="card-body text-center">
                <div class="position-relative d-inline-block mb-3">
                    <img id="profileAvatar" 
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%236b7280' font-size='48' font-family='Arial'%3EU%3C/text%3E%3C/svg%3E" 
                         alt="Avatar" 
                         class="rounded-circle"
                         style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--primary-100);">
                    <button class="btn btn-sm btn-primary rounded-circle position-absolute bottom-0 end-0" 
                            style="width: 36px; height: 36px; padding: 0;"
                            onclick="document.getElementById('avatarInput').click()">
                        <i class="bi bi-camera"></i>
                    </button>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(event)">
                </div>
                
                <h4 class="mb-1" id="profileName">Người dùng</h4>
                <p class="text-secondary mb-3" id="profileEmail">user@example.com</p>
                
                <div class="d-flex justify-content-center gap-3 mb-3">
                    <div class="text-center">
                        <div class="fw-bold text-primary" id="memberDays">0</div>
                        <small class="text-secondary">Ngày</small>
                    </div>
                    <div class="vr"></div>
                    <div class="text-center">
                        <div class="fw-bold text-success" id="totalTransactions">0</div>
                        <small class="text-secondary">Giao dịch</small>
                    </div>
                    <div class="vr"></div>
                    <div class="text-center">
                        <div class="fw-bold text-warning" id="levelBadge">1</div>
                        <small class="text-secondary">Cấp độ</small>
                    </div>
                </div>
                
                <span class="badge badge-primary" id="profileRole">USER</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card card-bordered mt-4">
            <div class="card-body">
                <h6 class="mb-3">Thao Tác Nhanh</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="showChangePasswordModal()">
                        <i class="bi bi-shield-lock"></i>
                        Đổi mật khẩu
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
                        <i class="bi bi-download"></i>
                        Xuất dữ liệu
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="showDeleteAccountModal()">
                        <i class="bi bi-trash"></i>
                        Xóa tài khoản
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings -->
    <div class="col-lg-8">
        <!-- Personal Information -->
        <div class="card card-bordered mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person"></i>
                    Thông Tin Cá Nhân
                </h5>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Họ và tên</label>
                            <input type="text" class="form-control" id="fullName" placeholder="Nhập họ tên">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="username" readonly disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="email@example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Số điện thoại</label>
                            <input type="tel" class="form-control" id="phone" placeholder="0123456789">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Ngày sinh</label>
                            <input type="date" class="form-control" id="birthDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Giới tính</label>
                            <select class="form-control" id="gender">
                                <option value="">Chọn giới tính</option>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-medium">Địa chỉ</label>
                            <textarea class="form-control" id="address" rows="2" placeholder="Nhập địa chỉ"></textarea>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="button" class="btn btn-primary" onclick="updateProfile()">
                            <i class="bi bi-check-lg"></i>
                            Lưu Thay Đổi
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadProfile()">
                            <i class="bi bi-arrow-clockwise"></i>
                            Làm Mới
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preferences -->
        <div class="card card-bordered mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-sliders"></i>
                    Tùy Chọn
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Ngôn ngữ</label>
                        <select class="form-control" id="language">
                            <option value="vi">Tiếng Việt</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Múi giờ</label>
                        <select class="form-control" id="timezone">
                            <option value="Asia/Ho_Chi_Minh">Việt Nam (GMT+7)</option>
                            <option value="Asia/Bangkok">Bangkok (GMT+7)</option>
                            <option value="Asia/Singapore">Singapore (GMT+8)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Đơn vị tiền tệ</label>
                        <select class="form-control" id="currency">
                            <option value="VND">VND (₫)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">Theme</label>
                        <select class="form-control" id="theme" onchange="changeTheme()">
                            <option value="light">Sáng</option>
                            <option value="dark">Tối</option>
                            <option value="auto">Tự động</option>
                        </select>
                    </div>
                </div>

                <hr class="my-4">

                <h6 class="mb-3">Thông Báo</h6>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                    <label class="form-check-label" for="emailNotifications">
                        Nhận thông báo qua email
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="budgetAlerts" checked>
                    <label class="form-check-label" for="budgetAlerts">
                        Cảnh báo vượt ngân sách
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="goalReminders" checked>
                    <label class="form-check-label" for="goalReminders">
                        Nhắc nhở mục tiêu
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="weeklyReports" checked>
                    <label class="form-check-label" for="weeklyReports">
                        Báo cáo hàng tuần
                    </label>
                </div>

                <div class="mt-4">
                    <button type="button" class="btn btn-primary" onclick="updatePreferences()">
                        <i class="bi bi-check-lg"></i>
                        Lưu Tùy Chọn
                    </button>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="card card-bordered">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i>
                    Bảo Mật
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-secondary rounded">
                    <div>
                        <h6 class="mb-1">Xác thực hai yếu tố (2FA)</h6>
                        <small class="text-secondary">Tăng cường bảo mật tài khoản</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enable2FA" onchange="toggle2FA()">
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center p-3 bg-secondary rounded">
                    <div>
                        <h6 class="mb-1">Phiên đăng nhập</h6>
                        <small class="text-secondary">Đăng nhập trên <span id="sessionCount">1</span> thiết bị</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="logoutAllSessions()">
                        Đăng xuất tất cả
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-secondary">
                        <i class="bi bi-info-circle"></i>
                        Lần đăng nhập cuối: <span id="lastLogin">--</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock"></i>
                    Đổi Mật Khẩu
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label class="form-label fw-medium">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-medium">Mật khẩu mới</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <small class="text-secondary">Tối thiểu 8 ký tự</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-medium">Xác nhận mật khẩu mới</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">
                    <i class="bi bi-check-lg"></i>
                    Đổi Mật Khẩu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Xóa Tài Khoản
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác! Tất cả dữ liệu của bạn sẽ bị xóa vĩnh viễn.
                </div>
                <p>Để xác nhận, vui lòng nhập mật khẩu của bạn:</p>
                <input type="password" class="form-control" id="deletePassword" placeholder="Mật khẩu">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">
                    <i class="bi bi-trash"></i>
                    Xóa Tài Khoản
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
    loadPreferences();
    loadStats();
});

// Load Profile
async function loadProfile() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/users/profile', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const user = await response.json();
            
            // Update profile display
            document.getElementById('profileName').textContent = user.fullName || user.username;
            document.getElementById('profileEmail').textContent = user.email || '';
            document.getElementById('profileRole').textContent = user.role || 'USER';
            
            if (user.avatarUrl) {
                document.getElementById('profileAvatar').src = user.avatarUrl;
            }
            
            // Fill form
            document.getElementById('fullName').value = user.fullName || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('birthDate').value = user.birthDate || '';
            document.getElementById('gender').value = user.gender || '';
            document.getElementById('address').value = user.address || '';
            
            if (user.lastLogin) {
                document.getElementById('lastLogin').textContent = new Date(user.lastLogin).toLocaleString('vi-VN');
            }
        }
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

// Load Preferences
async function loadPreferences() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.getElementById('theme').value = savedTheme;
    
    // Load other preferences from localStorage or API
    const preferences = JSON.parse(localStorage.getItem('preferences') || '{}');
    document.getElementById('language').value = preferences.language || 'vi';
    document.getElementById('timezone').value = preferences.timezone || 'Asia/Ho_Chi_Minh';
    document.getElementById('currency').value = preferences.currency || 'VND';
    document.getElementById('emailNotifications').checked = preferences.emailNotifications !== false;
    document.getElementById('budgetAlerts').checked = preferences.budgetAlerts !== false;
    document.getElementById('goalReminders').checked = preferences.goalReminders !== false;
    document.getElementById('weeklyReports').checked = preferences.weeklyReports !== false;
}

// Load Stats
async function loadStats() {
    try {
        const token = localStorage.getItem('accessToken');
        
        // Get user creation date
        const userResponse = await fetch('/api/users/profile', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (userResponse.ok) {
            const user = await userResponse.json();
            if (user.createdAt) {
                const memberDays = Math.floor((new Date() - new Date(user.createdAt)) / (1000 * 60 * 60 * 24));
                document.getElementById('memberDays').textContent = memberDays;
            }
        }
        
        // Get transaction count
        const txResponse = await fetch('/api/transactions', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (txResponse.ok) {
            const transactions = await txResponse.json();
            document.getElementById('totalTransactions').textContent = transactions.length;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Update Profile
async function updateProfile() {
    const data = {
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        birthday: document.getElementById('birthDate').value,
        gender: document.getElementById('gender').value,
        address: document.getElementById('address').value
    };
    
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/users/profile', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Cập nhật thông tin thành công!');
            loadProfile();
        } else {
            const error = await response.json();
            alert('Lỗi: ' + (error.message || 'Không thể cập nhật'));
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Lỗi khi cập nhật thông tin');
    }
}

// Update Preferences
function updatePreferences() {
    const preferences = {
        language: document.getElementById('language').value,
        timezone: document.getElementById('timezone').value,
        currency: document.getElementById('currency').value,
        emailNotifications: document.getElementById('emailNotifications').checked,
        budgetAlerts: document.getElementById('budgetAlerts').checked,
        goalReminders: document.getElementById('goalReminders').checked,
        weeklyReports: document.getElementById('weeklyReports').checked
    };
    
    localStorage.setItem('preferences', JSON.stringify(preferences));
    alert('Đã lưu tùy chọn!');
}

// Change Theme
function changeTheme() {
    const theme = document.getElementById('theme').value;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
}

// Upload Avatar
async function uploadAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('avatar', file);
    
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/users/avatar', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            document.getElementById('profileAvatar').src = result.avatarUrl;
            alert('Cập nhật ảnh đại diện thành công!');
        } else {
            alert('Lỗi khi tải ảnh lên');
        }
    } catch (error) {
        console.error('Error uploading avatar:', error);
        alert('Lỗi khi tải ảnh lên');
    }
}

// Show Change Password Modal
function showChangePasswordModal() {
    const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    modal.show();
}

// Change Password
async function changePassword() {
    const form = document.getElementById('changePasswordForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('Mật khẩu xác nhận không khớp!');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Mật khẩu mới phải có ít nhất 8 ký tự!');
        return;
    }
    
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/users/change-password', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ currentPassword, newPassword })
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
            alert('Đổi mật khẩu thành công!');
            form.reset();
        } else {
            const error = await response.json();
            alert('Lỗi: ' + (error.message || 'Mật khẩu hiện tại không đúng'));
        }
    } catch (error) {
        console.error('Error changing password:', error);
        alert('Lỗi khi đổi mật khẩu');
    }
}

// Toggle 2FA
function toggle2FA() {
    const enabled = document.getElementById('enable2FA').checked;
    alert(enabled ? 'Tính năng sẽ được triển khai sớm' : '2FA đã tắt');
}

// Logout All Sessions
async function logoutAllSessions() {
    if (!confirm('Đăng xuất khỏi tất cả thiết bị?')) return;
    
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/auth/logout-all', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Đã đăng xuất khỏi tất cả thiết bị!');
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error logging out:', error);
    }
}

// Export Data
function exportData() {
    alert('Tính năng xuất dữ liệu đang được phát triển');
}

// Show Delete Account Modal
function showDeleteAccountModal() {
    const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
    modal.show();
}

// Confirm Delete Account
async function confirmDeleteAccount() {
    const password = document.getElementById('deletePassword').value;
    if (!password) {
        alert('Vui lòng nhập mật khẩu!');
        return;
    }
    
    if (!confirm('Bạn có chắc chắn muốn xóa tài khoản vĩnh viễn?')) return;
    
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/users/account', {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password })
        });
        
        if (response.ok) {
            alert('Tài khoản đã được xóa!');
            localStorage.clear();
            window.location.href = '/login';
        } else {
            const error = await response.json();
            alert('Lỗi: ' + (error.message || 'Mật khẩu không đúng'));
        }
    } catch (error) {
        console.error('Error deleting account:', error);
        alert('Lỗi khi xóa tài khoản');
    }
}
</script>
