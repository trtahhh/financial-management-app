<!-- Modern AI Chat Page -->

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">AI Chat T√†i Ch√≠nh</h2>
        <p class="text-secondary mb-0">Tr√≤ chuy·ªán v·ªõi tr·ª£ l√Ω AI v·ªÅ t√†i ch√≠nh c·ªßa b·∫°n</p>
    </div>
    <button class="btn btn-outline-danger" onclick="clearChat()">
        <i class="bi bi-trash"></i>
        X√≥a L·ªãch S·ª≠
    </button>
</div>

<div class="row g-4">
    <!-- Chat Area -->
    <div class="col-lg-8">
        <div class="card card-bordered" style="height: calc(100vh - 250px); display: flex; flex-direction: column;">
            <!-- Chat Header -->
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="bi bi-robot fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <h6 class="mb-0">Finance AI Assistant</h6>
                        <small class="text-success">
                            <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i>
                            ƒêang ho·∫°t ƒë·ªông
                        </small>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="card-body flex-grow-1 overflow-auto" id="chatMessages" style="scroll-behavior: smooth;">
                <!-- Welcome Message -->
                <div class="text-center py-5">
                    <i class="bi bi-chat-dots" style="font-size: 3rem; color: var(--primary-200);"></i>
                    <h5 class="mt-3 mb-2">Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa b·∫°n</h5>
                    <p class="text-secondary mb-4">H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ t√†i ch√≠nh c·ªßa b·∫°n</p>
                    
                    <div class="row g-2 justify-content-center">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickQuestion('Ph√¢n t√≠ch chi ti√™u c·ªßa t√¥i')">
                                üìä Ph√¢n t√≠ch chi ti√™u c·ªßa t√¥i
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickQuestion('L√†m sao ƒë·ªÉ ti·∫øt ki·ªám nhi·ªÅu h∆°n?')">
                                üí∞ L√†m sao ƒë·ªÉ ti·∫øt ki·ªám nhi·ªÅu h∆°n?
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickQuestion('ƒê·ªÅ xu·∫•t ng√¢n s√°ch cho th√°ng t·ªõi')">
                                üìÖ ƒê·ªÅ xu·∫•t ng√¢n s√°ch cho th√°ng t·ªõi
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickQuestion('Ki·ªÉm tra s·ª©c kh·ªèe t√†i ch√≠nh')">
                                ‚ù§Ô∏è Ki·ªÉm tra s·ª©c kh·ªèe t√†i ch√≠nh
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="card-footer bg-white">
                <form id="chatForm" onsubmit="sendMessage(event)">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               id="messageInput" 
                               placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                               autocomplete="off">
                        <button class="btn btn-primary" type="submit" id="sendBtn">
                            <i class="bi bi-send"></i>
                            G·ª≠i
                        </button>
                    </div>
                </form>
                <div class="mt-2">
                    <small class="text-secondary">
                        <i class="bi bi-lightbulb"></i>
                        M·∫πo: H·ªèi v·ªÅ chi ti√™u, ng√¢n s√°ch, ti·∫øt ki·ªám, ho·∫∑c m·ª•c ti√™u t√†i ch√≠nh
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Stats -->
        <div class="card card-gradient mb-4">
            <div class="card-body text-white">
                <h6 class="text-white mb-3">
                    <i class="bi bi-graph-up"></i>
                    T√≥m T·∫Øt T√†i Ch√≠nh
                </h6>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="opacity-75">S·ªë d∆∞ hi·ªán t·∫°i</small>
                        <strong id="quickBalance">0 ‚Ç´</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <small class="opacity-75">Thu th√°ng n√†y</small>
                        <strong id="quickIncome">0 ‚Ç´</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="opacity-75">Chi th√°ng n√†y</small>
                        <strong id="quickExpense">0 ‚Ç´</strong>
                    </div>
                </div>
                <button class="btn btn-light btn-sm w-100" onclick="askAboutFinances()">
                    <i class="bi bi-chat-square-text"></i>
                    H·ªèi v·ªÅ s·ªë li·ªáu n√†y
                </button>
            </div>
        </div>

        <!-- Suggested Questions -->
        <div class="card card-bordered mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-question-circle"></i>
                    G·ª£i √ù C√¢u H·ªèi
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary text-start" onclick="sendQuickQuestion('T√¥i chi nhi·ªÅu nh·∫•t v√†o m·ª•c n√†o?')">
                        <i class="bi bi-arrow-right"></i>
                        T√¥i chi nhi·ªÅu nh·∫•t v√†o m·ª•c n√†o?
                    </button>
                    <button class="btn btn-sm btn-outline-primary text-start" onclick="sendQuickQuestion('So s√°nh thu chi th√°ng n√†y v·ªõi th√°ng tr∆∞·ªõc')">
                        <i class="bi bi-arrow-right"></i>
                        So s√°nh thu chi v·ªõi th√°ng tr∆∞·ªõc
                    </button>
                    <button class="btn btn-sm btn-outline-primary text-start" onclick="sendQuickQuestion('D·ª± ƒëo√°n chi ti√™u th√°ng t·ªõi')">
                        <i class="bi bi-arrow-right"></i>
                        D·ª± ƒëo√°n chi ti√™u th√°ng t·ªõi
                    </button>
                    <button class="btn btn-sm btn-outline-primary text-start" onclick="sendQuickQuestion('G·ª£i √Ω c√°ch t·ªëi ∆∞u chi ti√™u')">
                        <i class="bi bi-arrow-right"></i>
                        G·ª£i √Ω c√°ch t·ªëi ∆∞u chi ti√™u
                    </button>
                    <button class="btn btn-sm btn-outline-primary text-start" onclick="sendQuickQuestion('Ti·∫øn ƒë·ªô m·ª•c ti√™u c·ªßa t√¥i th·∫ø n√†o?')">
                        <i class="bi bi-arrow-right"></i>
                        Ti·∫øn ƒë·ªô m·ª•c ti√™u c·ªßa t√¥i?
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat History -->
        <div class="card card-bordered">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    L·ªãch S·ª≠ G·∫ßn ƒê√¢y
                </h6>
            </div>
            <div class="card-body">
                <div id="chatHistory">
                    <div class="text-center text-secondary py-3">
                        <small>Ch∆∞a c√≥ l·ªãch s·ª≠ chat</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let chatMessages = [];

document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    loadQuickStats();
    
    // Focus input
    document.getElementById('messageInput').focus();
});

// Load Chat History from localStorage
function loadChatHistory() {
    const saved = localStorage.getItem('chatMessages');
    if (saved) {
        chatMessages = JSON.parse(saved);
        renderMessages();
    }
}

// Save Chat History
function saveChatHistory() {
    localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
}

// Load Quick Stats
async function loadQuickStats() {
    try {
        const token = localStorage.getItem('accessToken');
        
        // Get wallets for balance
        const walletsResponse = await fetch('/api/wallets', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (walletsResponse.ok) {
            const wallets = await walletsResponse.json();
            const totalBalance = wallets.reduce((sum, w) => sum + (w.balance || 0), 0);
            document.getElementById('quickBalance').textContent = formatCurrency(totalBalance);
        }
        
        // Get transactions for income/expense
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const today = now.toISOString().split('T')[0];
        
        const txResponse = await fetch(`/api/transactions?from=${firstDay}&to=${today}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (txResponse.ok) {
            const transactions = await txResponse.json();
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('quickIncome').textContent = formatCurrency(income);
            document.getElementById('quickExpense').textContent = formatCurrency(expense);
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Send Message
async function sendMessage(event) {
    if (event) event.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });
        
        removeTypingIndicator();
        
        if (response.ok) {
            const data = await response.json();
            addMessage('ai', data.response);
        } else {
            addMessage('ai', 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i sau.');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        removeTypingIndicator();
        addMessage('ai', 'ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.');
    }
}

// Send Quick Question
function sendQuickQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage();
}

// Ask About Finances
function askAboutFinances() {
    sendQuickQuestion('Ph√¢n t√≠ch t·ªïng quan t√¨nh h√¨nh t√†i ch√≠nh hi·ªán t·∫°i c·ªßa t√¥i');
}

// Add Message
function addMessage(sender, text) {
    const message = {
        id: Date.now(),
        sender: sender,
        text: text,
        timestamp: new Date().toISOString()
    };
    
    chatMessages.push(message);
    saveChatHistory();
    renderMessages();
}

// Render Messages
function renderMessages() {
    const container = document.getElementById('chatMessages');
    
    // Clear welcome message if messages exist
    if (chatMessages.length > 0) {
        container.innerHTML = '';
    }
    
    chatMessages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex mb-3 ${msg.sender === 'user' ? 'justify-content-end' : ''}`;
        
        if (msg.sender === 'ai') {
            messageDiv.innerHTML = `
                <div class="me-2">
                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" 
                         style="width: 36px; height: 36px;">
                        <i class="bi bi-robot"></i>
                    </div>
                </div>
                <div class="flex-grow-1" style="max-width: 70%;">
                    <div class="bg-secondary p-3 rounded">
                        <div class="text-break">${escapeHtml(msg.text)}</div>
                    </div>
                    <small class="text-secondary">${formatTime(msg.timestamp)}</small>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="flex-grow-1 text-end" style="max-width: 70%;">
                    <div class="bg-primary text-white p-3 rounded">
                        <div class="text-break">${escapeHtml(msg.text)}</div>
                    </div>
                    <small class="text-secondary">${formatTime(msg.timestamp)}</small>
                </div>
            `;
        }
        
        container.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Show Typing Indicator
function showTypingIndicator() {
    const container = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'd-flex mb-3';
    typingDiv.innerHTML = `
        <div class="me-2">
            <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" 
                 style="width: 36px; height: 36px;">
                <i class="bi bi-robot"></i>
            </div>
        </div>
        <div class="bg-secondary p-3 rounded">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

// Remove Typing Indicator
function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// Clear Chat
function clearChat() {
    if (!confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ chat?')) return;
    
    chatMessages = [];
    localStorage.removeItem('chatMessages');
    location.reload();
}

// Helper Functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
/* Typing Animation */
.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        opacity: 0.3;
        transform: translateY(0);
    }
    30% {
        opacity: 1;
        transform: translateY(-8px);
    }
}

/* Scrollbar */
#chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: var(--neutral-300);
    border-radius: 3px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: var(--neutral-400);
}
</style>
