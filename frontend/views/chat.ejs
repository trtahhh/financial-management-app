<main class="container-fluid py-4" style="background: linear-gradient(135deg, #f8e8ff 0%, #fff5f8 100%); min-height: 100vh;">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Momo-style Header Card -->
      <div class="card shadow-lg border-0 mb-4" style="border-radius: 20px; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);">
        <div class="card-body text-white p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-white rounded-circle p-3 me-3 shadow">
              <i class="bi bi-robot" style="font-size: 2rem; background: linear-gradient(135deg, #a855f7, #ec4899); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"></i>
            </div>
            <div>
              <h4 class="mb-0 fw-bold">Tr·ª£ th·ªß AI - Moni</h4>
              <small class="opacity-75">Tr·ª£ th·ªß AI c√° nh√¢n c·ªßa b·∫°n</small>
              <div class="d-flex align-items-center mt-1">
                <span class="badge bg-success bg-opacity-75 px-2 py-1" style="border-radius: 10px;">
                  <i class="bi bi-circle-fill" style="font-size: 0.4rem;"></i> ƒêang ho·∫°t ƒë·ªông
                </span>
              </div>
            </div>
          </div>
          
          <!-- Personalized Greeting Card -->
          <div id="greeting-card" class="bg-white bg-opacity-20 backdrop-blur rounded-4 p-4 mb-3" style="backdrop-filter: blur(10px);">
            <div class="d-flex align-items-center">
              <div class="spinner-border text-white me-3" role="status" style="width: 1.5rem; height: 1.5rem;">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mb-0">ƒêang t·∫£i l·ªùi ch√†o...</p>
            </div>
          </div>
          
          <!-- Quick Actions Grid (Momo-style) -->
          <div id="quick-actions-grid" class="row g-2">
            <!-- Skeleton loaders -->
            <div class="col-6 col-md-4">
              <div class="bg-white bg-opacity-20 rounded-3 p-3 text-center">
                <div class="spinner-border spinner-border-sm text-white" role="status"></div>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="bg-white bg-opacity-20 rounded-3 p-3 text-center">
                <div class="spinner-border spinner-border-sm text-white" role="status"></div>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="bg-white bg-opacity-20 rounded-3 p-3 text-center">
                <div class="spinner-border spinner-border-sm text-white" role="status"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Suggested Actions Title -->
      <h6 class="fw-bold mb-3" style="color: #6b7280;">G·ª£i √Ω Moni d√†nh cho b·∫°n</h6>
      
      <!-- Horizontal Scrollable Suggestions (Momo-style) -->
      <div id="suggestions-carousel" class="mb-4" style="overflow-x: auto; overflow-y: hidden; white-space: nowrap; -webkit-overflow-scrolling: touch;">
        <div class="d-inline-flex gap-3 pb-2">
          <!-- Skeleton cards -->
          <div class="card border-0 shadow-sm" style="width: 200px; border-radius: 15px; display: inline-block;">
            <div class="card-body text-center p-3">
              <div class="placeholder-glow">
                <span class="placeholder col-8"></span>
                <span class="placeholder col-6"></span>
              </div>
            </div>
          </div>
          <div class="card border-0 shadow-sm" style="width: 200px; border-radius: 15px; display: inline-block;">
            <div class="card-body text-center p-3">
              <div class="placeholder-glow">
                <span class="placeholder col-8"></span>
                <span class="placeholder col-6"></span>
              </div>
            </div>
          </div>
          <div class="card border-0 shadow-sm" style="width: 200px; border-radius: 15px; display: inline-block;">
            <div class="card-body text-center p-3">
              <div class="placeholder-glow">
                <span class="placeholder col-8"></span>
                <span class="placeholder col-6"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Chat Messages Card -->
      <div class="card shadow-sm border-0" style="border-radius: 20px;">
        <div class="card-body p-0">
          <!-- Chat Messages Area -->
          <div class="chat-messages" id="chat-messages" style="height: 450px; overflow-y: auto; padding: 20px;">
            <!-- Messages will be appended here -->
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="card-footer bg-white border-0 p-4" style="border-radius: 0 0 20px 20px;">
          <div class="input-group align-items-center" style="background: #f3f4f6; border-radius: 25px; padding: 8px 15px;">
            <span class="input-group-text bg-transparent border-0 ps-0">
              <i class="bi bi-grid-3x3-gap-fill" style="color: #a855f7; cursor: pointer; font-size: 1.2rem;"></i>
            </span>
            <textarea class="form-control bg-transparent border-0 shadow-none px-2" id="message-input" 
                   placeholder="Nh·∫≠p n·ªôi dung, ho·∫∑c th·ª≠ g√µ @..." 
                   style="font-size: 0.95rem; resize: none; min-height: 40px;"></textarea>
            <button class="btn px-4 py-2 ms-2" id="send-button" 
                    style="background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border-radius: 20px; border: none; transition: all 0.3s;">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style>
/* Momo-style custom CSS */
.chat-messages {
  background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
}

.chat-message {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.quick-action-card {
  transition: all 0.2s ease;
  cursor: pointer;
}

.quick-action-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
}

.quick-action-card:active {
  transform: translateY(0);
}

#suggestions-carousel::-webkit-scrollbar {
  height: 6px;
}

#suggestions-carousel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

#suggestions-carousel::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #a855f7, #ec4899);
  border-radius: 10px;
}

/* Message bubbles */
.message-bubble-moni {
  background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
  border-radius: 18px 18px 18px 4px;
  padding: 15px;
  max-width: 85%;
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.1);
}

.message-bubble-user {
  background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
  color: white;
  border-radius: 18px 18px 4px 18px;
  padding: 15px;
  max-width: 85%;
  margin-left: auto;
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
}

.backdrop-blur {
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.suggestion-card {
  background: white;
  border-radius: 15px;
  padding: 15px;
  min-width: 200px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.suggestion-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 16px rgba(168, 85, 247, 0.15);
}

/* Typing animation */
@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

.typing-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  margin: 0 2px;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  border-radius: 50%;
}

.typing-dots {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
}
</style>

<script>
// Initialize chat interface with personalized greeting
document.addEventListener('DOMContentLoaded', function() {
    loadPersonalizedGreeting();
    loadQuickActions();
});

/**
 * Load personalized greeting from backend
 */
async function loadPersonalizedGreeting() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/ai/chat/greeting', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Failed to load greeting');
        
        const data = await response.json();
        
        // Update greeting card
        const greetingCard = document.getElementById('greeting-card');
        greetingCard.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="fs-2 me-3">‚ú®</div>
                <div class="flex-grow-1">
                    <p class="mb-0 fw-semibold" style="line-height: 1.6; white-space: pre-wrap;">${data.greeting}</p>
                </div>
            </div>
        `;
        
        // Update quick actions grid
        if (data.quickActions && data.quickActions.length > 0) {
            renderQuickActions(data.quickActions.slice(0, 6)); // Top 6 in header
            if (data.quickActions.length > 6) {
                renderSuggestions(data.quickActions.slice(6)); // Rest in carousel
            }
        }
        
    } catch (error) {
        console.error('Error loading greeting:', error);
        document.getElementById('greeting-card').innerHTML = `
            <p class="mb-0">üëã Xin ch√†o! Moni c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</p>
        `;
        
        // Load default quick actions
        loadDefaultQuickActions();
    }
}

/**
 * Load default quick actions if backend fails
 */
function loadDefaultQuickActions() {
    const defaultActions = [
        { emoji: 'üìä', text: 'Xem chi ti√™u th√°ng n√†y', action: 'ultra-insights' },
        { emoji: 'üîÆ', text: 'D·ª± ƒëo√°n ng√¢n s√°ch', action: 'category-forecast' },
        { emoji: 'üòä', text: 'Ph√¢n t√≠ch t√¢m tr·∫°ng', action: 'sentiment-analysis' },
        { emoji: 'üí°', text: 'L·ªùi khuy√™n AI', action: 'advice' },
        { emoji: 'üìà', text: 'Xu h∆∞·ªõng chi ti√™u', action: 'trend' },
        { emoji: 'üí∞', text: 'Ti·∫øt ki·ªám th√¥ng minh', action: 'saving' }
    ];
    
    renderQuickActions(defaultActions);
}

/**
 * Render quick action buttons in header
 */
function renderQuickActions(actions) {
    const grid = document.getElementById('quick-actions-grid');
    grid.innerHTML = actions.map(action => `
        <div class="col-6 col-md-4">
            <div class="bg-white bg-opacity-20 rounded-3 p-3 text-center quick-action-card" 
                 style="cursor: pointer; transition: all 0.2s; backdrop-filter: blur(10px);"
                 onclick="handleQuickAction('${action.action || action.text}', '${(action.text || '').replace(/'/g, "\\'")}')">
                <div class="fs-4 mb-1">${action.emoji || 'üí°'}</div>
                <small class="d-block text-white" style="font-size: 0.8rem; line-height: 1.2;">${action.text || action.action}</small>
            </div>
        </div>
    `).join('');
}

/**
 * Render suggestion cards in carousel
 */
function renderSuggestions(suggestions) {
    const carousel = document.getElementById('suggestions-carousel');
    const cardsHTML = suggestions.map(sug => `
        <div class="suggestion-card" onclick="handleQuickAction('${sug.action}', '${sug.text.replace(/'/g, "\\'")}')">
            <div class="text-center">
                <div class="fs-3 mb-2">${sug.emoji}</div>
                <small class="text-muted d-block" style="white-space: normal; line-height: 1.3;">${sug.text}</small>
            </div>
        </div>
    `).join('');
    
    carousel.innerHTML = `<div class="d-inline-flex gap-3 pb-2">${cardsHTML}</div>`;
}

/**
 * Load quick actions
 */
async function loadQuickActions() {
    // Already loaded in greeting endpoint
}

/**
 * Handle quick action click
 */
function handleQuickAction(action, text) {
    // Map action to Vietnamese query
    const actionMap = {
        'ultra-insights': 'Cho t√¥i xem Ultra AI Insights th√°ng n√†y',
        'category-forecast': 'D·ª± ƒëo√°n chi ti√™u ƒÇn u·ªëng',
        'sentiment-analysis': 'Ph√¢n t√≠ch t√¢m tr·∫°ng chi ti√™u th√°ng n√†y',
        'advice': 'Cho t√¥i l·ªùi khuy√™n t√†i ch√≠nh',
        'trend': 'Ph√¢n t√≠ch xu h∆∞·ªõng chi ti√™u',
        'saving': 'L·ªùi khuy√™n ti·∫øt ki·ªám th√¥ng minh',
        'help:features': 'Moni c√≥ th·ªÉ l√†m nh·ªØng g√¨?',
        'category:food': 'Ph√¢n t√≠ch chi ti√™u ƒÇn U·ªëng g·∫ßn ƒë√¢y',
        'voucher:lunch': 'T√¨m voucher ƒÇn Tr∆∞a',
        'advice:saving': '21 tu·ªïi, ti·∫øt ki·ªám nh∆∞ n√†o?',
        'insight:largest': 'Kho·∫£n chi l·ªõn nh·∫•t th√°ng qua'
    };
    
    const message = actionMap[action] || text || action;
    const input = document.getElementById('message-input') || document.getElementById('chat-input');
    
    if (input) {
        input.value = message;
        sendMessage();
    }
}

/**
 * Send message function
 */
function sendMessage() {
    const input = document.getElementById('message-input') || document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    appendMessage('user', message);
    input.value = '';
    
    // Call Ultra AI chat response (implemented in chat.js)
    if (typeof getUltraAIChatResponse === 'function') {
        showTypingIndicator();
        getUltraAIChatResponse(message).then(response => {
            hideTypingIndicator();
            appendMessage('ai', response);
        }).catch(error => {
            hideTypingIndicator();
            appendMessage('ai', '‚ö†Ô∏è **ƒê√£ c√≥ l·ªói x·∫£y ra**. Vui l√≤ng th·ª≠ l·∫°i sau.');
        });
    } else {
        // Fallback: Use sendChatMessage from chat.js
        sendChatMessage(message);
    }
}

/**
 * Show typing indicator
 */
function showTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator-moni';
    typingDiv.className = 'chat-message mb-3';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="bg-gradient-primary rounded-circle p-2 me-2" style="background: linear-gradient(135deg, #a855f7, #ec4899); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-robot text-white" style="font-size: 0.9rem;"></i>
            </div>
            <div class="message-bubble-moni">
                <div class="typing-dots">
                    <span class="typing-dot" style="animation: typing 1.4s infinite;"></span>
                    <span class="typing-dot" style="animation: typing 1.4s infinite 0.2s;"></span>
                    <span class="typing-dot" style="animation: typing 1.4s infinite 0.4s;"></span>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/**
 * Hide typing indicator
 */
function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator-moni');
    if (indicator) indicator.remove();
}

/**
 * Append message to chat
 */
function appendMessage(sender, content) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message mb-3 ${sender === 'user' ? 'text-end' : ''}`;
    
    // Format content with markdown
    const formattedContent = formatMessageContent(content);
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-bubble-user d-inline-block">
                ${formattedContent}
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="bg-gradient-primary rounded-circle p-2 me-2" style="background: linear-gradient(135deg, #a855f7, #ec4899); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-robot text-white" style="font-size: 0.9rem;"></i>
                </div>
                <div class="message-bubble-moni">
                    ${formattedContent}
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/**
 * Format message content (markdown support)
 */
function formatMessageContent(content) {
    // Convert **text** to <strong>text</strong>
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert line breaks to <br>
    content = content.replace(/\n/g, '<br>');
    
    // Convert emoji sequences
    content = content.replace(/üìä|üìà|üìâ|üí∞|üí°|üéØ|‚úÖ|‚ö†Ô∏è|üòä|üòê|üò¢|üîÆ|üåü|üß†/g, match => 
        `<span style="font-size: 1.2em;">${match}</span>`
    );
    
    return content;
}

/**
 * Handle enter key press
 */
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Placeholder for chat message sending (will integrate with existing chat.js)
async function sendChatMessage(message) {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });
        
        if (!response.ok) throw new Error('Chat request failed');
        
        const data = await response.json();
        
        // Display response
        if (data.success && data.response) {
            const resp = data.response;
            let responseHTML = `<strong>${resp.mainMessage}</strong>`;
            
            if (resp.transactions && resp.transactions.length > 0) {
                responseHTML += '<div class="mt-3"><small class="text-muted">Giao d·ªãch li√™n quan:</small><ul class="mt-2 mb-0">';
                resp.transactions.slice(0, 5).forEach(t => {
                    responseHTML += `<li><strong>${t.description}</strong> - ${Number(t.amount).toLocaleString('vi-VN')}ƒë (${t.date})</li>`;
                });
                responseHTML += '</ul></div>';
            }
            
            if (resp.insights && resp.insights.length > 0) {
                responseHTML += '<div class="mt-3"><small class="text-muted">üí° G·ª£i √Ω:</small><ul class="mt-2 mb-0">';
                resp.insights.forEach(ins => {
                    responseHTML += `<li>${ins}</li>`;
                });
                responseHTML += '</ul></div>';
            }
            
            appendMessage('moni', responseHTML);
        }
        
    } catch (error) {
        console.error('Chat error:', error);
        appendMessage('moni', '‚ùå Xin l·ªói, Moni g·∫∑p s·ª± c·ªë khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n.');
    }
}
</script>

<!-- Load main chat functionality -->
<script src="/js/chat.js"></script>
