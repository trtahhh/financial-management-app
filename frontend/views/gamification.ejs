<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamification - Financial Management</title>
    <%- include('partials/header') %>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/gamification.css">
</head>
<body>
    <div class="container">
        <h1> Gamification</h1>
        
        <!-- User Stats Overview -->
        <section class="section">
            <h2>Your Progress</h2>
            <div id="gamification-stats"></div>
        </section>
        
        <!-- Achievements Section -->
        <section class="section">
            <h2> Achievements</h2>
            <div id="achievements-list"></div>
        </section>
        
        <!-- Leaderboard Section -->
        <section class="section">
            <h2> Leaderboard</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchLeaderboard('points')">Top Points</button>
                <button class="tab-btn" onclick="switchLeaderboard('streak')">Top Streaks</button>
            </div>
            <div id="leaderboard"></div>
        </section>
        
        <!-- Challenges Section -->
        <section class="section">
            <h2> Active Challenges</h2>
            <div id="challenges-list"></div>
        </section>
    </div>
    
    <%- include('partials/footer') %>
    <script src="/js/auth-utils.js"></script>
    <script src="/js/gamification.js"></script>
    <script>
        // Switch between leaderboards
        async function switchLeaderboard(type) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (type === 'streak') {
                try {
                    const response = await fetch('/api/gamification/leaderboard/streak?limit=10', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load streak leaderboard');
                    
                    const leaderboard = await response.json();
                    displayStreakLeaderboard(leaderboard);
                } catch (error) {
                    console.error('Error loading streak leaderboard:', error);
                }
            } else {
                loadLeaderboard();
            }
        }
        
        // Display streak leaderboard
        function displayStreakLeaderboard(leaderboard) {
            const leaderboardContainer = document.getElementById('leaderboard');
            if (!leaderboardContainer) return;
            
            let html = `
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Current Streak</th>
                            <th>Longest Streak</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            leaderboard.forEach((entry, index) => {
                const rankIcon = index === 0 ? '�' : index === 1 ? '' : index === 2 ? '' : '';
                html += `
                    <tr class="rank-${index + 1}">
                        <td>${rankIcon} #${index + 1}</td>
                        <td>${entry.username}</td>
                        <td> ${entry.currentStreak} days</td>
                        <td>⭐ ${entry.longestStreak} days</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            leaderboardContainer.innerHTML = html;
        }
    </script>
</body>
</html>
