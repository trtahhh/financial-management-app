document.addEventListener('DOMContentLoaded', function () { const list = document.getElementById('goal-list'); const m = new bootstrap.Modal(document.getElementById('goal-modal')); const f = document.getElementById('goal-form'); const title = document.getElementById('goal-modal-title'); let editing = null; function getAuthHeaders() { const token = localStorage.getItem('accessToken'); const headers = { 'Content-Type': 'application/json' }; if (token) { headers['Authorization'] = 'Bearer ' + token; } return headers; } function updateTotalSavedAmount(goals) { const totalSaved = goals .filter(g => g.status === 'COMPLETED' || g.status === 'EXECUTED') .reduce((sum, g) => sum + (Number(g.targetAmount) || 0), 0); document.getElementById('total-saved-amount').textContent = totalSaved.toLocaleString('vi-VN') + ' VNĐ'; } function updateGoalCounts() { const activeGoalsCount = document.querySelectorAll('.goal-item').length; const completedGoalsCount = document.querySelectorAll('.completed-goal-item').length; document.getElementById('active-goals-count').textContent = activeGoalsCount; document.getElementById('completed-goals-count').textContent = completedGoalsCount; } function load() { loadGoals(); loadGoalStats(); loadGoalProgress(); loadCompletedGoals(); loadPrediction(); } function loadGoals() { fetch('http://localhost:8080/api/goals', { headers: getAuthHeaders() }) .then(r => r.json()) .then(goals => { console.log('Goals loaded:', goals); // Phân loại mục tiêu theo trạng thái const activeGoals = goals.filter(g => g.status !== 'COMPLETED' && g.status !== 'EXECUTED'); const completedGoals = goals.filter(g => g.status === 'COMPLETED'); const executedGoals = goals.filter(g => g.status === 'EXECUTED'); // Hiển thị mục tiêu đang thực hiện renderActiveGoals(activeGoals); // Hiển thị mục tiêu đã hoàn thành renderCompletedGoals(completedGoals); // Hiển thị mục tiêu đã thực hiện renderExecutedGoals(executedGoals); // Cập nhật số lượng updateGoalCounts(); // Cập nhật tổng tiền tiết kiệm updateTotalSavedAmount(goals); }) .catch(e => { console.error('Error loading goals:', e); document.getElementById('goal-list').innerHTML = '<div class="alert alert-danger">Lỗi tải danh sách mục tiêu</div>'; }); } function loadGoalStats() { fetch('http://localhost:8080/api/goals/stats', { headers: getAuthHeaders() }) .then(r => r.json()) .then(stats => { document.getElementById('active-goals-count').textContent = stats.activeGoals || 0; document.getElementById('completed-goals-count').textContent = stats.completedGoals || 0; const totalSaved = stats.totalSavedAmount || 0; document.getElementById('total-saved-amount').textContent = Number(totalSaved).toLocaleString('vi-VN') + ' VND'; }) .catch(e => { console.error('Error loading goal stats:', e); }); } function loadGoalProgress() { fetch('http://localhost:8080/api/goals/progress', { headers: getAuthHeaders() }) .then(r => r.json()) .then(goals => { const progressList = document.getElementById('goal-progress-list'); if (goals.length === 0) { progressList.innerHTML = '<div class="alert alert-info">Chưa có mục tiêu nào</div>'; return; } progressList.innerHTML = goals.map(goal => ` <div class="mb-3"> <div class="d-flex justify-content-between align-items-center mb-2"> <h6 class="mb-0">${goal.goalName}</h6> <span class="badge ${goal.status === 'completed' ? 'bg-success' : goal.status === 'near-completion' ? 'bg-warning' : 'bg-info'}"> ${goal.status === 'completed' ? 'Hoàn thành' : goal.status === 'near-completion' ? 'Gần hoàn thành' : 'Đang thực hiện'} </span> </div> <div class="progress"> <div class="progress-bar ${goal.status === 'completed' ? 'bg-success' : goal.status === 'near-completion' ? 'bg-warning' : 'bg-info'}" role="progressbar" style="width:${Math.min(goal.progressPercentage, 100)}%" aria-valuenow="${goal.progressPercentage}" aria-valuemin="0" aria-valuemax="100"> ${goal.progressPercentage.toFixed(1)}% </div> </div> <small class="text-muted"> Mục tiêu: ${Number(goal.targetAmount).toLocaleString('vi-VN')} VND | Hiện tại: ${Number(goal.currentBalance).toLocaleString('vi-VN')} VND </small> </div> `).join(''); }) .catch(e => { console.error('Error loading goal progress:', e); }); } function loadCompletedGoals() { fetch('http://localhost:8080/api/goals/completed', { headers: getAuthHeaders() }) .then(r => r.json()) .then(goals => { const completedList = document.getElementById('completed-goals-list'); if (goals.length === 0) { completedList.innerHTML = '<div class="alert alert-info">Chưa có mục tiêu nào hoàn thành</div>'; return; } completedList.innerHTML = goals.map(goal => ` <div class="card mb-2 border-success"> <div class="card-body"> <div class="d-flex justify-content-between align-items-center"> <div> <h6 class="card-title text-success mb-1">${goal.name}</h6> <small class="text-muted"> Hoàn thành: ${goal.completedAt ? new Date(goal.completedAt).toLocaleDateString('vi-VN') : 'Chưa xác định'} </small> </div> <div class="text-end"> <div class="text-success fw-bold"> ${Number(goal.targetAmount).toLocaleString('vi-VN')} VND </div> <small class="text-muted">Số tiền tiết kiệm</small> </div> </div> </div> </div> `).join(''); }) .catch(e => { console.error('Error loading completed goals:', e); }); } function loadPrediction() { fetch('http://localhost:8080/api/goals/predict', { headers: getAuthHeaders() }) .then(r => r.json()) .then(p => { document.getElementById('predict').textContent = p.message; }) .catch(e => {}); } function renderActiveGoals(goals) { const list = document.getElementById('goal-list'); list.innerHTML = ''; if (goals.length === 0) { list.innerHTML = '<div class="alert alert-info">Chưa có mục tiêu nào đang thực hiện. Hãy thêm mục tiêu đầu tiên!</div>'; return; } for (const goal of goals) { const div = document.createElement('div'); div.className = 'card mb-3 goal-item'; // Format target amount with VND currency const targetAmount = goal.targetAmount ? Number(goal.targetAmount).toLocaleString('vi-VN') + ' VND' : 'Chưa xác định'; // Format due date const dueDate = goal.dueDate ? new Date(goal.dueDate).toLocaleDateString('vi-VN') : 'Chưa xác định'; // Calculate progress const progress = goal.progress || 0; div.innerHTML = ` <div class="card-body"> <div class="d-flex justify-content-between align-items-center mb-2"> <h5 class="card-title mb-0">${goal.name}</h5> <div> <button class="btn btn-sm btn-outline-primary edit" data-id="${goal.id}">Sửa</button> <button class="btn btn-sm btn-outline-danger ms-2 del" data-id="${goal.id}">Xoá</button> ${progress >= 100 ? '<button class="btn btn-sm btn-success ms-2 complete" data-id="' + goal.id + '">Hoàn thành</button>' : ''} ${progress >= 100 && !goal.isExecuted ? '<button class="btn btn-sm btn-warning ms-2 execute" data-id="' + goal.id + '">Thực hiện mục tiêu</button>' : ''} ${goal.isExecuted ? '<span class="badge bg-success ms-2">Đã thực hiện</span>' : ''} </div> </div> <div class="mb-2"> <strong>Cần đạt:</strong> ${targetAmount}<br> <strong>Đến:</strong> ${dueDate} </div> <div class="progress mb-2"> <div class="progress-bar ${progress >= 100 ? 'bg-success' : progress >= 50 ? 'bg-warning' : 'bg-info'}" role="progressbar" style="width:${Math.min(progress, 100)}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"> ${progress.toFixed(1)}% </div> </div> </div> `; list.appendChild(div); } } function renderCompletedGoals(goals) { const list = document.getElementById('completed-goals-list'); list.innerHTML = ''; if (goals.length === 0) { list.innerHTML = '<div class="alert alert-info">Chưa có mục tiêu nào đã hoàn thành.</div>'; return; } for (const goal of goals) { const div = document.createElement('div'); div.className = 'card mb-3 completed-goal-item bg-light'; const targetAmount = goal.targetAmount ? Number(goal.targetAmount).toLocaleString('vi-VN') + ' VND' : 'Chưa xác định'; const completedDate = goal.completedAt ? new Date(goal.completedAt).toLocaleDateString('vi-VN') : 'Chưa xác định'; div.innerHTML = ` <div class="card-body"> <div class="d-flex justify-content-between align-items-center mb-2"> <h6 class="card-title mb-0 text-success">${goal.name}</h6> <span class="badge bg-success">Đã hoàn thành</span> </div> <div class="mb-2"> <strong>Mục tiêu:</strong> ${targetAmount}<br> <strong>Hoàn thành:</strong> ${completedDate} </div> <div class="text-center"> <button class="btn btn-sm btn-warning execute" data-id="${goal.id}">Thực hiện mục tiêu</button> </div> </div> `; list.appendChild(div); } } function renderExecutedGoals(goals) { const list = document.getElementById('completed-goals-list'); if (goals.length === 0) { return; } for (const goal of goals) { const div = document.createElement('div'); div.className = 'card mb-3 executed-goal-item bg-success text-white'; const targetAmount = goal.targetAmount ? Number(goal.targetAmount).toLocaleString('vi-VN') + ' VND' : 'Chưa xác định'; const executedDate = goal.executedAt ? new Date(goal.executedAt).toLocaleDateString('vi-VN') : 'Chưa xác định'; div.innerHTML = ` <div class="card-body"> <div class="d-flex justify-content-between align-items-center mb-2"> <h6 class="card-title mb-0">${goal.name}</h6> <span class="badge bg-light text-dark">Đã thực hiện</span> </div> <div class="mb-2"> <strong>Số tiền:</strong> ${targetAmount}<br> <strong>Thực hiện:</strong> ${executedDate} </div> <div class="text-center"> <span class="badge bg-light text-success"> Mục tiêu đã được thực hiện thành công!</span> </div> </div> `; list.appendChild(div); } } document.getElementById('goal-add-btn').addEventListener('click', function () { editing = null; f.reset(); title.textContent = 'Thêm mục tiêu'; m.show(); }); // � AI Planning Wizard button document.getElementById('ai-planning-btn').addEventListener('click', function () { const planningModal = new bootstrap.Modal(document.getElementById('ai-planning-modal')); planningModal.show(); // Reset to step 1 document.getElementById('planning-step-1').style.display = 'block'; document.getElementById('planning-step-2').style.display = 'none'; document.getElementById('planning-loading').style.display = 'none'; document.getElementById('ai-planning-form').reset(); }); // � AI Planning Form Submit document.getElementById('ai-planning-form').addEventListener('submit', async function(e) { e.preventDefault(); const months = parseInt(document.getElementById('plan-months').value); const targetSavings = parseFloat(document.getElementById('target-savings').value); // Show loading document.getElementById('planning-step-1').style.display = 'none'; document.getElementById('planning-loading').style.display = 'block'; try { const response = await fetch('http://localhost:8080/api/ai/long-term-plan', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ months: months, targetSavings: targetSavings }) }); const data = await response.json(); if (data.success && data.plan) { displayAIPlan(data.plan, months, targetSavings); } else { alert('Không thể tạo kế hoạch: ' + (data.error || 'Lỗi không xác định')); document.getElementById('planning-step-1').style.display = 'block'; } } catch (error) { console.error('AI Planning error:', error); alert('Lỗi kết nối: ' + error.message); document.getElementById('planning-step-1').style.display = 'block'; } finally { document.getElementById('planning-loading').style.display = 'none'; } }); list.addEventListener('click', function (e) { const id = e.target.dataset.id; if (e.target.classList.contains('edit')) { fetch('http://localhost:8080/api/goals/' + id, { headers: getAuthHeaders() }) .then(r => r.json()) .then(response => { const goal = response.data || response; editing = id; f.name.value = goal.name || ''; f.target_amount.value = goal.targetAmount || ''; f.due_date.value = goal.dueDate ? goal.dueDate.substring(0,10) : ''; title.textContent = 'Sửa mục tiêu'; m.show(); }).catch(e => { console.error('Error loading goal:', e); alert('Lỗi tải thông tin mục tiêu: ' + e.message); }); } if (e.target.classList.contains('del')) { if (confirm('Bạn chắc chắn xoá mục tiêu này?')) { fetch('http://localhost:8080/api/goals/' + id, { method: 'DELETE', headers: getAuthHeaders() }) .then(r => r.json()) .then(response => { if (response.message) { // Success case load(); } else if (response.error) { // Error case alert('Lỗi xóa mục tiêu: ' + response.error); } else { // Fallback load(); } }) .catch(e => { console.error('Error deleting goal:', e); alert('Lỗi xóa mục tiêu: ' + e.message); }); } } if (e.target.classList.contains('execute')) { if (confirm('Bạn chắc chắn muốn thực hiện mục tiêu này? Hệ thống sẽ trừ tiền từ ví và tạo giao dịch chi tiêu.')) { fetch('http://localhost:8080/api/goals/' + id + '/execute', { method: 'POST', headers: getAuthHeaders() }) .then(r => r.json()) .then(response => { if (response.success) { alert(` ${response.message}\n\nSố tiền: ${Number(response.transaction.amount).toLocaleString('vi-VN')} VND\nVí: ${response.walletName}\nSố dư mới: ${Number(response.newBalance).toLocaleString('vi-VN')} VND`); // Tự động xóa mục tiêu đã thực hiện khỏi danh sách đang thực hiện const goalElement = e.target.closest('.goal-item'); if (goalElement) { goalElement.style.animation = 'fadeOut 0.5s ease-out'; setTimeout(() => { goalElement.remove(); // Cập nhật số lượng mục tiêu đang thực hiện updateGoalCounts(); }, 500); } // Reload để cập nhật UI và danh sách mục tiêu đã thực hiện load(); } else { alert(' Lỗi: ' + response.error); } }) .catch(e => { console.error('Error executing goal:', e); alert('Lỗi thực hiện mục tiêu: ' + e.message); }); } } }); f.addEventListener('submit', function (e) { e.preventDefault(); const data = { name: f.name.value, targetAmount: +f.target_amount.value, dueDate: f.due_date.value }; if (!data.name.trim()) { alert('Tên mục tiêu không được để trống'); return; } if (!data.targetAmount || data.targetAmount <= 0) { alert('Số tiền mục tiêu phải lớn hơn 0'); return; } const method = editing ? 'PUT' : 'POST'; const url = 'http://localhost:8080/api/goals' + (editing ? '/' + editing : ''); fetch(url, { method, headers: getAuthHeaders(), body: JSON.stringify(data) }) .then(r => r.json()) .then(response => { if (response.success !== false) { m.hide(); load(); } else { alert('Lỗi lưu mục tiêu: ' + (response.message || 'Unknown error')); } }) .catch(e => { console.error('Error saving goal:', e); alert('Lỗi lưu mục tiêu: ' + e.message); }); }); load(); }); // � Global variables for AI planning let currentAIPlan = null; /** * Display AI long-term plan result */ function displayAIPlan(plan, months, targetSavings) { currentAIPlan = plan; const resultDiv = document.getElementById('ai-plan-result'); let html = ''; // Plan summary html += '<div class="alert alert-success">'; html += '<h6> Kế hoạch ' + months + ' tháng</h6>'; html += '<p><strong>Mục tiêu:</strong> ' + targetSavings.toLocaleString('vi-VN') + ' VNĐ</p>'; if (plan.monthlySavingsRequired) { html += '<p><strong>Cần tiết kiệm mỗi tháng:</strong> ' + plan.monthlySavingsRequired.toLocaleString('vi-VN') + ' VNĐ</p>'; } if (plan.savingsRate) { html += '<p><strong>Tỷ lệ tiết kiệm:</strong> ' + plan.savingsRate + '%</p>'; } if (plan.feasibility) { // Map backend levels: impossible, very_difficult, difficult, achievable, easy let color, text; const level = plan.feasibility.level || plan.feasibility; // Support both object and string switch(level.toLowerCase()) { case 'impossible': color = 'danger'; text = 'Không khả thi'; break; case 'very_difficult': color = 'danger'; text = 'Rất khó đạt'; break; case 'difficult': color = 'warning'; text = 'Khó đạt được'; break; case 'achievable': color = 'info'; text = 'Có thể đạt được'; break; case 'easy': color = 'success'; text = 'Dễ đạt được'; break; default: color = 'secondary'; text = level; } html += '<p><strong>Độ khả thi:</strong> <span class="badge bg-' + color + '">' + text + '</span></p>'; } html += '</div>'; // Monthly breakdown if (plan.monthlyBreakdown && plan.monthlyBreakdown.length > 0) { html += '<h6>Chi tiết từng tháng:</h6>'; html += '<div class="table-responsive">'; html += '<table class="table table-sm table-bordered">'; html += '<thead><tr><th>Tháng</th><th>Thu nhập dự kiến</th><th>Chi tiêu tối đa</th><th>Tiết kiệm</th><th>Tích lũy</th></tr></thead>'; html += '<tbody>'; plan.monthlyBreakdown.forEach(month => { html += '<tr>'; html += '<td>Tháng ' + month.month + '</td>'; html += '<td>' + (month.expectedIncome || 0).toLocaleString('vi-VN') + ' VNĐ</td>'; html += '<td>' + (month.maxSpending || 0).toLocaleString('vi-VN') + ' VNĐ</td>'; html += '<td class="text-success"><strong>' + (month.savings || 0).toLocaleString('vi-VN') + ' VNĐ</strong></td>'; html += '<td class="text-primary"><strong>' + (month.cumulativeSavings || 0).toLocaleString('vi-VN') + ' VNĐ</strong></td>'; html += '</tr>'; }); html += '</tbody></table>'; html += '</div>'; } // Recommendations if (plan.recommendations && plan.recommendations.length > 0) { html += '<h6 class="mt-3"> Đề xuất của AI:</h6>'; html += '<ul class="list-group">'; plan.recommendations.forEach(rec => { html += '<li class="list-group-item">' + rec + '</li>'; }); html += '</ul>'; } // Category optimization if (plan.categoryOptimizations && plan.categoryOptimizations.length > 0) { html += '<h6 class="mt-3"> Tối ưu hóa theo danh mục:</h6>'; html += '<ul class="list-group">'; plan.categoryOptimizations.forEach(opt => { html += '<li class="list-group-item">'; html += '<strong>' + opt.category + ':</strong> '; html += 'Giảm ' + (opt.currentSpending - opt.suggestedSpending).toLocaleString('vi-VN') + ' VNĐ '; html += '(từ ' + opt.currentSpending.toLocaleString('vi-VN') + ' → ' + opt.suggestedSpending.toLocaleString('vi-VN') + ' VNĐ)'; if (opt.suggestion) { html += '<br><small class="text-muted"> ' + opt.suggestion + '</small>'; } html += '</li>'; }); html += '</ul>'; } resultDiv.innerHTML = html; // Show step 2 document.getElementById('planning-step-1').style.display = 'none'; document.getElementById('planning-step-2').style.display = 'block'; } /** * Back to planning step 1 */ function backToPlanningStep1() { document.getElementById('planning-step-1').style.display = 'block'; document.getElementById('planning-step-2').style.display = 'none'; currentAIPlan = null; } /** * Apply AI plan as a new goal */ function applyPlanAsGoal() { if (!currentAIPlan) { alert('Không có kế hoạch để áp dụng'); return; } const months = parseInt(document.getElementById('plan-months').value); const targetSavings = parseFloat(document.getElementById('target-savings').value); // Calculate due date (today + months) const dueDate = new Date(); dueDate.setMonth(dueDate.getMonth() + months); // Create goal from AI plan const goalData = { name: 'Kế hoạch tiết kiệm ' + months + ' tháng (AI)', targetAmount: targetSavings, dueDate: dueDate.toISOString().split('T')[0] }; fetch('http://localhost:8080/api/goals', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(goalData) }) .then(r => r.json()) .then(response => { if (response.success !== false) { alert(' Đã tạo mục tiêu từ kế hoạch AI!'); // Close modal const modal = bootstrap.Modal.getInstance(document.getElementById('ai-planning-modal')); modal.hide(); // Reload goals load(); } else { alert('Lỗi tạo mục tiêu: ' + (response.message || 'Unknown error')); } }) .catch(e => { console.error('Error creating goal from AI plan:', e); alert('Lỗi: ' + e.message); }); } // ============================================================ // SAVINGS PATH (LỘ TRÌNH TIẾT KIỆM) // ============================================================ function showSavingsPathModal() { const modal = new bootstrap.Modal(document.getElementById('savings-path-modal')); modal.show(); } async function submitSavingsPath() { const amount = parseFloat(document.getElementById('savings-path-amount').value); const purpose = document.getElementById('savings-path-purpose').value; const resultDiv = document.getElementById('savings-path-result'); if (!amount || amount <= 0) { alert('Vui lòng nhập số tiền hợp lệ'); return; } if (!purpose) { alert('Vui lòng chọn mục đích'); return; } resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary spinner-border-sm"></div> Đang tạo lộ trình...</div>'; try { const response = await fetch('http://localhost:8080/api/ai/suggest-savings-path', { method: 'POST', headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ targetAmount: amount, purpose: purpose }) }); if (!response.ok) throw new Error('Failed to generate savings path'); const data = await response.json(); displaySavingsPath(data); } catch (error) { console.error('Savings path error:', error); resultDiv.innerHTML = '<div class="alert alert-warning"> Không thể tạo lộ trình tiết kiệm</div>'; } } function displaySavingsPath(data) { const resultDiv = document.getElementById('savings-path-result'); if (!resultDiv) return; let html = '<div class="savings-path-results mt-3">'; // Timeline if (data.timeline) { html += ` <div class="alert alert-info"> <strong>⏱️ Thời gian:</strong> ${data.timeline} </div> `; } // Monthly savings needed if (data.monthlySavings) { html += ` <div class="alert alert-success"> <strong> Tiết kiệm mỗi tháng:</strong> ${data.monthlySavings.toLocaleString()} VND </div> `; } // Steps/Milestones if (data.steps && data.steps.length > 0) { html += '<div class="mt-3"><strong> Các bước thực hiện:</strong><ol>'; data.steps.forEach(step => { html += `<li class="mb-2">${step}</li>`; }); html += '</ol></div>'; } // Recommendations if (data.recommendations && data.recommendations.length > 0) { html += '<div class="mt-3"><strong> Khuyến nghị:</strong><ul>'; data.recommendations.forEach(rec => { html += `<li class="text-muted">${rec}</li>`; }); html += '</ul></div>'; } html += '</div>'; resultDiv.innerHTML = html; } // ============================================================ // SAVINGS TIPS (KNOWLEDGE BASE) // ============================================================ function showSavingsTipsModal() { const modal = new bootstrap.Modal(document.getElementById('savings-tips-modal')); modal.show(); } async function loadSavingsTips() { const category = document.getElementById('savings-tips-category').value; const purpose = document.getElementById('savings-tips-purpose').value; const resultDiv = document.getElementById('savings-tips-result'); resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-info spinner-border-sm"></div> Đang tìm tips...</div>'; try { let url = 'http://localhost:8080/api/ai/savings-tips'; const params = []; if (category) params.push(`category=${encodeURIComponent(category)}`); if (purpose) params.push(`purpose=${encodeURIComponent(purpose)}`); if (params.length > 0) { url += '?' + params.join('&'); } const response = await fetch(url, { headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}`, 'Content-Type': 'application/json' } }); if (!response.ok) throw new Error('Failed to load savings tips'); const data = await response.json(); displaySavingsTips(data.tips || []); } catch (error) { console.error('Savings tips error:', error); resultDiv.innerHTML = '<div class="alert alert-warning"> Không thể tải tips</div>'; } } function displaySavingsTips(tips) { const resultDiv = document.getElementById('savings-tips-result'); if (!resultDiv) return; if (!tips || tips.length === 0) { resultDiv.innerHTML = '<p class="text-muted">Không tìm thấy tips phù hợp</p>'; return; } let html = '<div class="tips-list mt-3" style="max-height: 400px; overflow-y: auto;">'; tips.forEach(tip => { const iconMap = { 'food': '', 'transport': '', 'shopping': '', 'education': '', 'emergency': '', 'vacation': '', 'investment': '', 'general': '' }; const icon = iconMap[tip.category?.toLowerCase()] || ''; html += ` <div class="card mb-2"> <div class="card-body p-3"> <div class="d-flex align-items-start"> <div class="me-3 fs-3">${icon}</div> <div class="flex-grow-1"> <h6 class="mb-1">${tip.title}</h6> <p class="mb-2 text-muted small">${tip.description}</p> ${tip.category ? `<span class="badge bg-secondary">${tip.category}</span>` : ''} ${tip.difficulty ? `<span class="badge bg-info ms-1">${tip.difficulty}</span>` : ''} ${tip.potentialSavings ? `<div class="text-success small mt-2"> Tiết kiệm: ~${tip.potentialSavings}</div>` : ''} </div> </div> </div> </div> `; }); html += '</div>'; resultDiv.innerHTML = html; } // ========== NEW ENHANCED FEATURES ========== // Load Milestone Timeline async function loadMilestoneTimeline() { const token = localStorage.getItem('accessToken'); try { const response = await fetch('http://localhost:8080/api/goals', { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { const goals = await response.json(); renderMilestoneTimeline(goals); } } catch (error) { console.error('Error loading milestones:', error); } } // Render Milestone Timeline function renderMilestoneTimeline(goals) { const container = document.getElementById('milestone-timeline'); if (!container) return; if (goals.length === 0) { container.innerHTML = ` <div class="text-center text-muted py-4"> <i class="fas fa-flag fa-3x mb-3"></i> <p>No milestones yet. Create your first goal to start tracking!</p> </div> `; return; } // Sort by deadline const sortedGoals = goals.sort((a, b) => new Date(a.deadline) - new Date(b.deadline)); let html = ''; sortedGoals.forEach((goal, index) => { const progress = goal.currentAmount && goal.targetAmount ? Math.min(100, (goal.currentAmount / goal.targetAmount) * 100) : 0; const isCompleted = progress >= 100 || goal.status === 'COMPLETED'; const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24)); html += ` <div class="milestone-item ${isCompleted ? 'completed' : 'pending'}"> <div class="row align-items-center"> <div class="col-md-2 text-center"> <div class="progress-ring"> <svg width="120" height="120"> <circle cx="60" cy="60" r="50" fill="none" stroke="#e9ecef" stroke-width="10"/> <circle cx="60" cy="60" r="50" fill="none" stroke="${isCompleted ? '#28a745' : '#ffc107'}" stroke-width="10" stroke-dasharray="${(progress / 100) * 314} 314" stroke-linecap="round"/> </svg> <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"> <h4 class="mb-0 ${isCompleted ? 'text-success' : 'text-warning'}">${Math.round(progress)}%</h4> </div> </div> </div> <div class="col-md-7"> <h5 class="mb-1"> ${isCompleted ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-clock text-warning"></i>'} ${goal.name} </h5> <p class="text-muted mb-2">${goal.description || 'No description'}</p> <div class="row g-2 small"> <div class="col-auto"> <span class="badge bg-primary"> <i class="fas fa-bullseye"></i> Target: ${formatCurrency(goal.targetAmount)} </span> </div> <div class="col-auto"> <span class="badge bg-info"> <i class="fas fa-wallet"></i> Current: ${formatCurrency(goal.currentAmount || 0)} </span> </div> <div class="col-auto"> <span class="badge ${daysLeft > 0 ? 'bg-warning' : 'bg-danger'}"> <i class="fas fa-calendar"></i> ${daysLeft > 0 ? daysLeft + ' days left' : 'Overdue'} </span> </div> </div> </div> <div class="col-md-3 text-center"> ${isCompleted ? `<button class="btn btn-success btn-sm" onclick="triggerCelebration('${goal.name}', ${goal.targetAmount})"> <i class="fas fa-trophy"></i> Celebrate! </button>` : `<button class="btn btn-outline-primary btn-sm" onclick="quickAddProgress(${goal.id})"> <i class="fas fa-plus"></i> Add Progress </button>` } </div> </div> </div> `; }); container.innerHTML = html; } // Quick Add Progress function quickAddProgress(goalId) { const amount = prompt('Enter amount to add to this goal:'); if (!amount || isNaN(amount)) return; const token = localStorage.getItem('accessToken'); fetch(`http://localhost:8080/api/goals/${goalId}`, { headers: { 'Authorization': `Bearer ${token}` } }) .then(r => r.json()) .then(goal => { const updatedAmount = (goal.currentAmount || 0) + parseFloat(amount); return fetch(`http://localhost:8080/api/goals/${goalId}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ...goal, currentAmount: updatedAmount }) }); }) .then(r => r.json()) .then(() => { showToast('Progress updated successfully!', 'success'); loadMilestoneTimeline(); // Check if goal is now complete const goal = document.querySelector(`[data-goal-id="${goalId}"]`); if (goal) { const progress = parseFloat(goal.dataset.progress); if (progress >= 100) { setTimeout(() => triggerCelebration(goal.dataset.goalName, goal.dataset.targetAmount), 500); } } }) .catch(err => { console.error('Error updating progress:', err); showToast('Failed to update progress', 'danger'); }); } // Trigger Celebration function triggerCelebration(goalName, amount) { const overlay = document.getElementById('celebration-overlay'); const title = document.getElementById('celebration-title'); const message = document.getElementById('celebration-message'); title.textContent = ' Goal Achieved!'; message.textContent = `You've reached your goal: ${goalName}! (${formatCurrency(amount)})`; overlay.style.display = 'flex'; // Create confetti for (let i = 0; i < 50; i++) { setTimeout(() => createConfetti(), i * 50); } // Play celebration sound (optional) try { const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGmi77eeeTRAN'); audio.play().catch(() => {}); } catch (e) {} } // Close Celebration function closeCelebration() { document.getElementById('celebration-overlay').style.display = 'none'; // Remove all confetti document.querySelectorAll('.confetti-piece').forEach(el => el.remove()); } // Create Confetti Piece function createConfetti() { const colors = ['#ffc107', '#28a745', '#007bff', '#dc3545', '#17a2b8']; const confetti = document.createElement('div'); confetti.className = 'confetti-piece'; confetti.style.left = Math.random() * 100 + '%'; confetti.style.background = colors[Math.floor(Math.random() * colors.length)]; confetti.style.animationDelay = Math.random() * 0.3 + 's'; document.body.appendChild(confetti); setTimeout(() => confetti.remove(), 3000); } // Load Goal Recommendations async function loadGoalRecommendations() { const token = localStorage.getItem('accessToken'); const userId = getUserIdFromToken(); const container = document.getElementById('recommendations-result'); container.innerHTML = ` <div class="text-center py-3"> <div class="spinner-border text-info" role="status"></div> <p class="mt-2 text-muted">Analyzing your finances...</p> </div> `; try { // Get AI recommendations based on spending patterns const response = await fetch(`http://localhost:8080/api/ai/personalized-tips?userId=${userId}`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { const data = await response.json(); displayGoalRecommendations(data); } else { container.innerHTML = ` <div class="alert alert-warning"> <i class="fas fa-exclamation-triangle"></i> Unable to load recommendations. Please try again later. </div> `; } } catch (error) { console.error('Error loading recommendations:', error); container.innerHTML = ` <div class="alert alert-danger"> <i class="fas fa-times-circle"></i> Error connecting to AI service. </div> `; } } // Display Goal Recommendations function displayGoalRecommendations(data) { const container = document.getElementById('recommendations-result'); const tips = data.tips || data.recommendations || []; if (tips.length === 0) { container.innerHTML = ` <div class="alert alert-info"> <i class="fas fa-info-circle"></i> No specific recommendations available yet. Keep tracking your expenses! </div> `; return; } let html = '<div class="list-group">'; tips.slice(0, 5).forEach((tip, index) => { html += ` <div class="list-group-item list-group-item-action"> <div class="d-flex align-items-start"> <span class="badge bg-info me-2">${index + 1}</span> <div> <h6 class="mb-1">${tip.title || 'Recommendation'}</h6> <p class="mb-1 small text-muted">${tip.description || tip}</p> ${tip.potential_savings ? ` <span class="badge bg-success"> <i class="fas fa-piggy-bank"></i> Save: ${formatCurrency(tip.potential_savings)} </span> ` : ''} </div> </div> </div> `; }); html += '</div>'; container.innerHTML = html; } // Calculate Savings Time function calculateSavingsTime() { const target = parseFloat(document.getElementById('calc-target').value); const monthly = parseFloat(document.getElementById('calc-monthly').value); const result = document.getElementById('calculator-result'); if (!target || !monthly || target <= 0 || monthly <= 0) { result.innerHTML = ` <div class="alert alert-warning"> <i class="fas fa-exclamation-triangle"></i> Please enter valid amounts. </div> `; return; } const months = Math.ceil(target / monthly); const years = Math.floor(months / 12); const remainingMonths = months % 12; let timeText = ''; if (years > 0) { timeText = `${years} year${years > 1 ? 's' : ''}`; if (remainingMonths > 0) { timeText += ` and ${remainingMonths} month${remainingMonths > 1 ? 's' : ''}`; } } else { timeText = `${months} month${months > 1 ? 's' : ''}`; } const completionDate = new Date(); completionDate.setMonth(completionDate.getMonth() + months); result.innerHTML = ` <div class="card bg-light"> <div class="card-body"> <h5 class="text-success mb-3"> <i class="fas fa-calendar-check"></i> Timeline Calculation </h5> <div class="mb-2"> <strong>Time Required:</strong> ${timeText} </div> <div class="mb-2"> <strong>Completion Date:</strong> ${completionDate.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' })} </div> <div class="mb-2"> <strong>Total Months:</strong> ${months} </div> <hr> <div class="alert alert-success mb-0"> <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> If you increase your monthly savings by 20%, you'll reach your goal ${Math.ceil(months * 0.2)} months earlier! </div> </div> </div> `; } // Helper: Get User ID function getUserIdFromToken() { try { const token = localStorage.getItem('accessToken'); if (!token) return null; const payload = token.split('.')[1]; const decoded = JSON.parse(atob(payload)); return decoded.userId || decoded.sub || null; } catch (error) { console.error('Error extracting userId:', error); return null; } } // Helper: Format Currency function formatCurrency(amount) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount); } // Helper: Show Toast function showToast(message, type = 'info') { let container = document.getElementById('toastContainer'); if (!container) { container = document.createElement('div'); container.id = 'toastContainer'; container.className = 'position-fixed top-0 end-0 p-3'; container.style.zIndex = '9999'; document.body.appendChild(container); } const toastId = 'toast-' + Date.now(); const toast = document.createElement('div'); toast.id = toastId; toast.className = `toast align-items-center text-white bg-${type} border-0`; toast.setAttribute('role', 'alert'); toast.innerHTML = ` <div class="d-flex"> <div class="toast-body">${message}</div> <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button> </div> `; container.appendChild(toast); const bsToast = new bootstrap.Toast(toast); bsToast.show(); toast.addEventListener('hidden.bs.toast', () => toast.remove()); } // Initialize milestone timeline on page load document.addEventListener('DOMContentLoaded', () => { setTimeout(() => { loadMilestoneTimeline(); }, 1000); }); 